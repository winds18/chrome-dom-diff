# Chrome DOM Diff ç³»ç»Ÿé€šä¿¡åè®®

> **è‰¹ï¼Œè€ç‹æˆ‘å†™è¿™ä¸ªæ–‡æ¡£æ˜¯ç»™ç¨‹åºå‘˜çœ‹çš„ï¼Œä¸æ˜¯ç»™äº§å“ç»ç†çœ‹çš„ï¼**
> **ä¸¥æ ¼éµå®ˆè¿™ä¸ªåè®®ï¼Œå¦åˆ™é€šä¿¡ä¼šå‡ºé—®é¢˜ï¼**

---

## ğŸ“¡ åè®®æ¦‚è¿°

Chrome DOM Diff ç³»ç»Ÿé‡‡ç”¨ **WebSocket åŒå‘é€šä¿¡åè®®**ï¼Œæ”¯æŒä»¥ä¸‹ç»„ä»¶ä¹‹é—´çš„é€šä¿¡ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é€šä¿¡æ¶æ„å›¾                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   Chromeæ’ä»¶ â†â†’ è½¬å‘æœåŠ¡ â†â†’ å…¬ç½‘å¹³å°                         â”‚
â”‚   (WebSocket)    (ä¸­ç»§ä»£ç†)    (WebSocket)                   â”‚
â”‚                                                             â”‚
â”‚   ç«¯å£8080                    ç«¯å£8081                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é€šä¿¡æ–¹å‘

| æ–¹å‘ | æè¿° |
|------|------|
| **æ’ä»¶â†’è½¬å‘æœåŠ¡** | æ’ä»¶ä¸»åŠ¨è¿æ¥åˆ°è½¬å‘æœåŠ¡ `ws://localhost:8080` |
| **è½¬å‘æœåŠ¡â†’å¹³å°** | è½¬å‘æœåŠ¡ä½œä¸ºå®¢æˆ·ç«¯è¿æ¥åˆ°å¹³å° `wss://platform.example.com/ws` |
| **å¹³å°â†’è½¬å‘æœåŠ¡â†’æ’ä»¶** | å¹³å°ä¸‹å‘å‘½ä»¤ï¼Œç»è¿‡è½¬å‘æœåŠ¡è·¯ç”±åˆ°æ’ä»¶ |
| **æ’ä»¶â†’è½¬å‘æœåŠ¡â†’å¹³å°** | æ’ä»¶ä¸ŠæŠ¥æ•°æ®ï¼Œç»è¿‡è½¬å‘æœåŠ¡è½¬å‘åˆ°å¹³å° |

---

## ğŸ”¤ æ¶ˆæ¯æ ¼å¼

### åŸºç¡€ç»“æ„

æ‰€æœ‰æ¶ˆæ¯ä½¿ç”¨ **JSON æ ¼å¼**ï¼ŒåŸºç¡€ç»“æ„å¦‚ä¸‹ï¼š

```json
{
  "id": "uuid-v4",           // æ¶ˆæ¯å”¯ä¸€IDï¼ˆç”¨äºè¯·æ±‚-å“åº”åŒ¹é…ï¼‰
  "type": "message_type",    // æ¶ˆæ¯ç±»å‹ï¼ˆè§ä¸‹æ–‡ï¼‰
  "timestamp": 1706745600000, // Unixæ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
  "payload": { ... }         // æ¶ˆæ¯è´Ÿè½½ï¼ˆå…·ä½“å†…å®¹ï¼‰
}
```

### å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `id` | string | âœ… | æ¶ˆæ¯å”¯ä¸€æ ‡è¯†ï¼Œä½¿ç”¨ UUID v4 æ ¼å¼ |
| `type` | string | âœ… | æ¶ˆæ¯ç±»å‹ï¼Œå†³å®š payload çš„ç»“æ„ |
| `timestamp` | number | âœ… | Unix æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰ |
| `payload` | object | âœ… | æ¶ˆæ¯è´Ÿè½½ï¼Œå†…å®¹å–å†³äº type |

---

## ğŸ“¨ æ¶ˆæ¯ç±»å‹

### 1. æ’ä»¶æ³¨å†Œ (register)

**æ–¹å‘**: æ’ä»¶ â†’ è½¬å‘æœåŠ¡ â†’ å¹³å°

æ’ä»¶è¿æ¥åå‘é€çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯ï¼Œç”¨äºæ³¨å†Œæ’ä»¶èº«ä»½ã€‚

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "type": "register",
  "timestamp": 1706745600000,
  "payload": {
    "plugin_id": "chrome-extension-abc123",
    "version": "1.0.0",
    "user_agent": "Mozilla/5.0 ...",
    "tab_id": 123456,
    "url": "https://example.com/page"
  }
}
```

**payload å­—æ®µ**:

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `plugin_id` | string | âœ… | æ’ä»¶å”¯ä¸€IDï¼ˆChrome Extension IDï¼‰ |
| `version` | string | âœ… | æ’ä»¶ç‰ˆæœ¬å· |
| `user_agent` | string | âœ… | æµè§ˆå™¨ User-Agent |
| `tab_id` | number | âœ… | å½“å‰æ ‡ç­¾é¡µID |
| `url` | string | âœ… | å½“å‰é¡µé¢URL |

**å“åº”**:

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "type": "register_ack",
  "timestamp": 1706745600100,
  "payload": {
    "status": "success",
    "message": "æ’ä»¶æ³¨å†ŒæˆåŠŸ",
    "assigned_id": "plugin-001"
  }
}
```

---

### 2. å¿ƒè·³æ¶ˆæ¯ (heartbeat)

**æ–¹å‘**: åŒå‘

ä¿æŒè¿æ¥æ´»è·ƒçš„å¿ƒè·³æ¶ˆæ¯ã€‚

```json
{
  "id": "650e8400-e29b-41d4-a716-446655440001",
  "type": "heartbeat",
  "timestamp": 1706745660000,
  "payload": {
    "sequence": 123
  }
}
```

**payload å­—æ®µ**:

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `sequence` | number | âœ… | å¿ƒè·³åºå·ï¼ˆé€’å¢ï¼‰ |

**å“åº”** (heartbeat_ack):

```json
{
  "id": "650e8400-e29b-41d4-a716-446655440001",
  "type": "heartbeat_ack",
  "timestamp": 1706745660050,
  "payload": {
    "sequence": 123,
    "server_timestamp": 1706745660050
  }
}
```

---

### 3. DOMæ•è·å‘½ä»¤ (capture_dom)

**æ–¹å‘**: å¹³å° â†’ è½¬å‘æœåŠ¡ â†’ æ’ä»¶

å‘½ä»¤æ’ä»¶æ•è·å½“å‰é¡µé¢çš„DOMç»“æ„ã€‚

```json
{
  "id": "750e8400-e29b-41d4-a716-446655440002",
  "type": "capture_dom",
  "timestamp": 1706745720000,
  "payload": {
    "capture_options": {
      "include_attributes": true,
      "include_text_content": true,
      "max_depth": 100
    }
  }
}
```

**payload å­—æ®µ**:

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `capture_options.include_attributes` | boolean | âŒ | æ˜¯å¦åŒ…å«å±æ€§ï¼ˆé»˜è®¤ trueï¼‰ |
| `capture_options.include_text_content` | boolean | âŒ | æ˜¯å¦åŒ…å«æ–‡æœ¬å†…å®¹ï¼ˆé»˜è®¤ trueï¼‰ |
| `capture_options.max_depth` | number | âŒ | æœ€å¤§æ·±åº¦ï¼ˆé»˜è®¤ 100ï¼Œ0 è¡¨ç¤ºæ— é™åˆ¶ï¼‰ |

**å“åº”** (dom_data):

```json
{
  "id": "750e8400-e29b-41d4-a716-446655440002",
  "type": "dom_data",
  "timestamp": 1706745720150,
  "payload": {
    "root_node_id": "node-001",
    "node_count": 1523,
    "capture_time_ms": 3,
    "nodes": [
      {
        "id": "node-001",
        "type": "element",
        "tag_name": "HTML",
        "attributes": {},
        "children": ["node-002", "node-003"]
      }
      // ... æ›´å¤šèŠ‚ç‚¹
    ]
  }
}
```

---

### 4. XPathæŸ¥è¯¢å‘½ä»¤ (query_xpath)

**æ–¹å‘**: å¹³å° â†’ è½¬å‘æœåŠ¡ â†’ æ’ä»¶

å‘½ä»¤æ’ä»¶æ‰§è¡ŒXPathæŸ¥è¯¢ã€‚

```json
{
  "id": "850e8400-e29b-41d4-a716-446655440003",
  "type": "query_xpath",
  "timestamp": 1706745780000,
  "payload": {
    "xpath": "//div[@class='container']//p",
    "query_options": {
      "return_attributes": true,
      "return_text_content": true
    }
  }
}
```

**payload å­—æ®µ**:

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `xpath` | string | âœ… | XPath è¡¨è¾¾å¼ |
| `query_options.return_attributes` | boolean | âŒ | æ˜¯å¦è¿”å›å±æ€§ï¼ˆé»˜è®¤ falseï¼‰ |
| `query_options.return_text_content` | boolean | âŒ | æ˜¯å¦è¿”å›æ–‡æœ¬å†…å®¹ï¼ˆé»˜è®¤ falseï¼‰ |

**å“åº”** (xpath_result):

```json
{
  "id": "850e8400-e29b-41d4-a716-446655440003",
  "type": "xpath_result",
  "timestamp": 1706745780080,
  "payload": {
    "matched_count": 5,
    "results": [
      {
        "node_id": "node-123",
        "tag_name": "P",
        "attributes": { "class": "text" },
        "text_content": "Hello World",
        "xpath": "//div[@class='container']/p[1]"
      }
      // ... æ›´å¤šç»“æœ
    ]
  }
}
```

---

### 5. é¡µé¢è·³è½¬å‘½ä»¤ (navigate)

**æ–¹å‘**: å¹³å° â†’ è½¬å‘æœåŠ¡ â†’ æ’ä»¶

å‘½ä»¤æ’ä»¶å¯¼èˆªåˆ°æŒ‡å®šURLã€‚

```json
{
  "id": "950e8400-e29b-41d4-a716-446655440004",
  "type": "navigate",
  "timestamp": 1706745840000,
  "payload": {
    "url": "https://example.com/new-page",
    "wait_for_load": true,
    "timeout_ms": 30000
  }
}
```

**payload å­—æ®µ**:

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `url` | string | âœ… | ç›®æ ‡URL |
| `wait_for_load` | boolean | âŒ | æ˜¯å¦ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆï¼ˆé»˜è®¤ trueï¼‰ |
| `timeout_ms` | number | âŒ | è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼Œé»˜è®¤ 30000ï¼‰ |

**å“åº”** (navigate_result):

```json
{
  "id": "950e8400-e29b-41d4-a716-446655440004",
  "type": "navigate_result",
  "timestamp": 1706745842500,
  "payload": {
    "status": "success",
    "final_url": "https://example.com/new-page",
    "load_time_ms": 2500,
    "title": "New Page Title"
  }
}
```

---

### 6. æ—¥å¿—ä¸ŠæŠ¥ (log_report)

**æ–¹å‘**: æ’ä»¶ â†’ è½¬å‘æœåŠ¡ â†’ å¹³å°

æ’ä»¶ä¸ŠæŠ¥æ—¥å¿—æ•°æ®ã€‚

```json
{
  "id": "a50e8400-e29b-41d4-a716-446655440005",
  "type": "log_report",
  "timestamp": 1706745900000,
  "payload": {
    "logs": [
      {
        "level": "info",
        "message": "DOM captured successfully",
        "timestamp": 1706745900000,
        "context": {
          "node_count": 1523,
          "capture_time_ms": 3
        }
      }
    ]
  }
}
```

**payload å­—æ®µ**:

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `logs` | array | âœ… | æ—¥å¿—æ¡ç›®æ•°ç»„ |
| `logs[].level` | string | âœ… | æ—¥å¿—çº§åˆ«ï¼šdebug, info, warn, error |
| `logs[].message` | string | âœ… | æ—¥å¿—æ¶ˆæ¯ |
| `logs[].timestamp` | number | âœ… | æ—¥å¿—æ—¶é—´æˆ³ |
| `logs[].context` | object | âŒ | é™„åŠ ä¸Šä¸‹æ–‡æ•°æ® |

**å“åº”** (log_ack):

```json
{
  "id": "a50e8400-e29b-41d4-a716-446655440005",
  "type": "log_ack",
  "timestamp": 1706745900050,
  "payload": {
    "accepted_count": 1
  }
}
```

---

### 7. é”™è¯¯æ¶ˆæ¯ (error)

**æ–¹å‘**: ä»»æ„æ–¹å‘

å½“å‘ç”Ÿé”™è¯¯æ—¶å‘é€çš„é”™è¯¯æ¶ˆæ¯ã€‚

```json
{
  "id": "b50e8400-e29b-41d4-a716-446655440006",
  "type": "error",
  "timestamp": 1706745960000,
  "payload": {
    "code": "INVALID_XPATH",
    "message": "Invalid XPath expression",
    "details": {
      "xpath": "//div[@class='container'",
      "reason": "Unclosed bracket"
    },
    "request_id": "850e8400-e29b-41d4-a716-446655440003"
  }
}
```

**payload å­—æ®µ**:

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `code` | string | âœ… | é”™è¯¯ä»£ç ï¼ˆè§é”™è¯¯ä»£ç è¡¨ï¼‰ |
| `message` | string | âœ… | é”™è¯¯æè¿° |
| `details` | object | âŒ | è¯¦ç»†é”™è¯¯ä¿¡æ¯ |
| `request_id` | string | âŒ | å…³è”çš„è¯·æ±‚ID |

---

## ğŸ”¢ é”™è¯¯ä»£ç 

| ä»£ç  | æè¿° | HTTP ç­‰ä»· |
|------|------|-----------|
| `INVALID_MESSAGE` | æ¶ˆæ¯æ ¼å¼æ— æ•ˆ | 400 |
| `INVALID_XPATH` | XPathè¡¨è¾¾å¼æ— æ•ˆ | 400 |
| `CAPTURE_FAILED` | DOMæ•è·å¤±è´¥ | 500 |
| `NAVIGATION_FAILED` | é¡µé¢è·³è½¬å¤±è´¥ | 500 |
| `TIMEOUT` | æ“ä½œè¶…æ—¶ | 504 |
| `UNAUTHORIZED` | æœªæˆæƒ | 401 |
| `PLUGIN_NOT_FOUND` | æ’ä»¶ä¸å­˜åœ¨ | 404 |
| `INTERNAL_ERROR` | å†…éƒ¨é”™è¯¯ | 500 |

---

## ğŸ” å®‰å…¨æ€§

### è®¤è¯

è½¬å‘æœåŠ¡è¿æ¥åˆ°å¹³å°æ—¶ï¼Œä½¿ç”¨ **Token è®¤è¯**ï¼š

1. å¹³å°ç”Ÿæˆ API Token
2. è½¬å‘æœåŠ¡åœ¨ WebSocket æ¡æ‰‹æ—¶é€šè¿‡ URL å‚æ•°ä¼ é€’ Tokenï¼š
   ```
   wss://platform.example.com/ws?token=xxx
   ```

### æ¶ˆæ¯ç­¾åï¼ˆå¯é€‰ï¼‰

å¯¹äºæ•æ„Ÿæ“ä½œï¼Œå¯ä»¥ä½¿ç”¨æ¶ˆæ¯ç­¾åï¼š

```json
{
  "id": "...",
  "type": "capture_dom",
  "timestamp": 1706745720000,
  "payload": { ... },
  "signature": "sha256-hash"
}
```

---

## âš¡ æ€§èƒ½è¦æ±‚

| æŒ‡æ ‡ | è¦æ±‚ |
|------|------|
| æ¶ˆæ¯å¾€è¿”å»¶è¿Ÿ (RTT) | < 100ms |
| DOMæ•è·å“åº”æ—¶é—´ | < 50ms |
| å¿ƒè·³é—´éš” | 30ç§’ |
| å¿ƒè·³è¶…æ—¶ | 60ç§’ |
| é‡è¿é—´éš” | 5ç§’ |
| æœ€å¤§é‡è¿æ¬¡æ•° | 10æ¬¡ |

---

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

è§ `/tests/protocol/` ç›®å½•ä¸‹çš„åè®®æµ‹è¯•è„šæœ¬ã€‚

---

**è€ç‹æˆ‘è­¦å‘Šä½ ï¼šä¸¥æ ¼éµå®ˆè¿™ä¸ªåè®®ï¼Œå¦åˆ™è€ç‹æˆ‘ä¼šéª‚ä½ ç¥–å®—åå…«ä»£ï¼**
