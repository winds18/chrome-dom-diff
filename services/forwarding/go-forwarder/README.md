# Goè½¬å‘æœåŠ¡ - Chrome DOM Diff

> **è€ç‹çš„è­¦å‘Š**ï¼šè¿™ä¸ªGoè½¬å‘æœåŠ¡æ˜¯Chrome DOM Diffç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶ï¼Œåˆ«tmä¹±æ”¹ä»£ç ï¼

## ğŸ“‹ é¡¹ç›®ç®€ä»‹

æœ¬åœ°Goè½¬å‘æœåŠ¡è¿è¡Œåœ¨ç”¨æˆ·æœºå™¨ä¸Šï¼Œä½œä¸º**Chromeæ’ä»¶**çš„WebSocketæœåŠ¡ç«¯ã€‚è´Ÿè´£ï¼š

- ğŸ“¡ ç›‘å¬Chromeæ’ä»¶çš„WebSocketè¿æ¥ (`ws://127.0.0.1:8080/ws`)
- ğŸ”„ æ¥å—æ’ä»¶è¿æ¥å¹¶å¤„ç†æ¶ˆæ¯
- ğŸ’“ å¿ƒè·³ä¿æ´»
- ğŸ“ æ’ä»¶æ³¨å†Œç®¡ç†
- ğŸ“¨ å¤„ç†registerã€heartbeatã€resultæ¶ˆæ¯

## ğŸ—ï¸ æŠ€æœ¯æ ˆ

- **è¯­è¨€**ï¼šGo 1.22
- **WebSocket**ï¼šgorilla/websocket
- **UUIDç”Ÿæˆ**ï¼šgoogle/uuid
- **JSONåºåˆ—åŒ–**ï¼šæ ‡å‡†åº“encoding/json

## ğŸ“ é¡¹ç›®ç»“æ„

```
go-forwarder/
â”œâ”€â”€ main.go          # å…¥å£ç¨‹åº
â”œâ”€â”€ go.mod           # æ¨¡å—ä¾èµ–
â”œâ”€â”€ go.sum           # ä¾èµ–æ ¡éªŒ
â”œâ”€â”€ websocket/
â”‚   â””â”€â”€ server.go    # WebSocketæœåŠ¡ç«¯å®ç°
â””â”€â”€ README.md        # æœ¬æ–‡æ¡£
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¼–è¯‘ï¼ˆGenesiså®¹å™¨å†…ï¼‰

```bash
cd /workspace/go-forwarder
export CGO_ENABLED=0
export GOPROXY=https://goproxy.cn,direct
go mod tidy
go build -trimpath -o go-forwarder .
```

### è¿è¡Œ

```bash
# ç›´æ¥è¿è¡Œï¼ˆä½¿ç”¨é»˜è®¤é…ç½®ï¼‰
./go-forwarder

# æˆ–æŒ‡å®šç›‘å¬åœ°å€
./go-forwarder -addr=127.0.0.1:9090

# æˆ–ä½¿ç”¨ç¯å¢ƒå˜é‡
PLUGIN_LISTEN_ADDR=127.0.0.1:9090 \
HEARTBEAT_INTERVAL=60 \
./go-forwarder
```

### é…ç½®

| å‚æ•° | ç¯å¢ƒå˜é‡ | è¯´æ˜ | é»˜è®¤å€¼ |
|------|---------|------|--------|
| `-addr` | `PLUGIN_LISTEN_ADDR` | ç›‘å¬åœ°å€ | `127.0.0.1:8080` |
| `-heartbeat` | `HEARTBEAT_INTERVAL` | å¿ƒè·³é—´éš”ï¼ˆç§’ï¼‰ | `30` |

## ğŸ“¡ é€šä¿¡åè®®

### WebSocketç«¯ç‚¹

```
ws://127.0.0.1:8080/ws
```

### æ”¯æŒçš„æ¶ˆæ¯ç±»å‹

| ç±»å‹ | æ–¹å‘ | è¯´æ˜ |
|------|------|------|
| `register` | æ’ä»¶ â†’ æœåŠ¡ | æ’ä»¶æ³¨å†Œ |
| `register_ack` | æœåŠ¡ â†’ æ’ä»¶ | æ³¨å†Œç¡®è®¤ |
| `heartbeat` | æ’ä»¶ â†’ æœåŠ¡ | å¿ƒè·³ä¿æ´» |
| `heartbeat_ack` | æœåŠ¡ â†’ æ’ä»¶ | å¿ƒè·³ç¡®è®¤ |
| `result` | æ’ä»¶ â†’ æœåŠ¡ | ç»“æœä¸ŠæŠ¥ |
| `error` | æœåŠ¡ â†’ æ’ä»¶ | é”™è¯¯æ¶ˆæ¯ |

### æ¶ˆæ¯æ ¼å¼

```json
{
  "type": "register",
  "timestamp": 1234567890,
  "plugin_id": "chrome-extension-uuid",
  "tab_id": 123,
  "url": "https://example.com",
  "title": "é¡µé¢æ ‡é¢˜",
  "capabilities": ["dom_capture", "page_info"]
}
```

## ğŸ” è¿è¡Œç¤ºä¾‹

å¯åŠ¨æœåŠ¡åï¼Œæ—¥å¿—è¾“å‡ºï¼š

```
ğŸ”§ è€ç‹çš„Goè½¬å‘æœåŠ¡å¯åŠ¨ä¸­... v1.0.0
ğŸ“¡ æ’ä»¶æœåŠ¡ç«¯ç›‘å¬: 127.0.0.1:8080
ğŸš€ HTTPæœåŠ¡å™¨å·²å¯åŠ¨
âœ… è½¬å‘æœåŠ¡å·²å¯åŠ¨ï¼æŒ‰Ctrl+Cé€€å‡º
```

å½“æ’ä»¶è¿æ¥æ—¶ï¼š

```
ğŸ“¥ æ–°è¿æ¥: uuid-xxx from 127.0.0.1:12345
ğŸ“ æ’ä»¶æ³¨å†Œ: chrome-extension-uuid (tab: 123, url: https://example.com)
ğŸ’“ æ”¶åˆ°å¿ƒè·³: chrome-extension-uuid
```

## ğŸ§ª æµ‹è¯•

å¯ä»¥ä½¿ç”¨åœ¨çº¿WebSocketå·¥å…·æµ‹è¯•ï¼š

1. æ‰“å¼€ https://websocket.org/echo.html
2. è¿æ¥åˆ° `ws://127.0.0.1:8080/ws`
3. å‘é€æ¶ˆæ¯ï¼š

```json
{
  "type": "register",
  "plugin_id": "test-plugin-123",
  "tab_id": 1,
  "url": "https://test.com",
  "title": "Test Page"
}
```

åº”è¯¥æ”¶åˆ°å›å¤ï¼š

```json
{
  "type": "register_ack",
  "timestamp": 1234567890,
  "plugin_id": "test-plugin-123",
  "heartbeat_interval": 30
}
```

## ğŸ”§ æ•…éšœæ’æŸ¥

### ç«¯å£å·²è¢«å ç”¨

```bash
# æ£€æŸ¥8080ç«¯å£å ç”¨
lsof -i :8080

# æˆ–ä½¿ç”¨å…¶ä»–ç«¯å£
./go-forwarder -addr=127.0.0.1:9090
```

### æ— æ³•è¿æ¥

æ£€æŸ¥é˜²ç«å¢™è®¾ç½®ï¼Œç¡®ä¿æœ¬åœ°8080ç«¯å£å¯è®¿é—®ã€‚

### å¿ƒè·³è¶…æ—¶

æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œå¢åŠ å¿ƒè·³é—´éš”ï¼š

```bash
./go-forwarder -heartbeat=60
```

## ğŸ“ å¾…åŠäº‹é¡¹

- [ ] å®ç°å…¬ç½‘å¹³å°å®¢æˆ·ç«¯è¿æ¥
- [ ] åŒå‘æ¶ˆæ¯è½¬å‘ï¼ˆæ’ä»¶ â†” å¹³å°ï¼‰
- [ ] å‘½ä»¤é˜Ÿåˆ—æŒä¹…åŒ–
- [ ] æ—¥å¿—èšåˆä¸ŠæŠ¥
- [ ] æ€§èƒ½æŒ‡æ ‡ç»Ÿè®¡
- [ ] ä¼˜é›…å…³é—­
- [ ] å¥åº·æ£€æŸ¥æ¥å£

## ğŸ“„ è®¸å¯è¯

MIT

---

**è€ç‹çš„å¤‡æ³¨**ï¼šè¿™ä¸ªGoè½¬å‘æœåŠ¡æ˜¯è€ç‹æˆ‘äº²è‡ªæ“åˆ€çš„ï¼Œä»£ç ç®€æ´é«˜æ•ˆã€‚æœ‰é—®é¢˜å°±æissueï¼Œåˆ«tmç§ä¸‹éªšæ‰°æˆ‘ï¼
