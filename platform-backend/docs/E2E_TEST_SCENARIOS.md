# 端到端测试场景文档

> **艹，这个文档描述了完整的端到端测试场景！**
> **老王我写这个是为了确保系统在各种场景下都能正常工作！**

---

## 📋 测试场景概览

| ID | 场景名称 | 优先级 | 状态 |
|----|----------|--------|------|
| E2E-001 | 插件注册流程 | P0 | 待实现 |
| E2E-002 | 心跳保活机制 | P0 | 待实现 |
| E2E-003 | DOM捕获命令执行 | P0 | 待实现 |
| E2E-004 | XPath查询命令执行 | P0 | 待实现 |
| E2E-005 | 页面跳转命令执行 | P1 | 待实现 |
| E2E-006 | 日志上报和聚合 | P1 | 待实现 |
| E2E-007 | 网络中断恢复 | P1 | 待实现 |
| E2E-008 | 转发服务重启恢复 | P2 | 待实现 |
| E2E-009 | 并发多插件连接 | P1 | 待实现 |
| E2E-010 | 大DOM树传输 | P2 | 待实现 |
| E2E-011 | 命令超时重试 | P1 | 待实现 |
| E2E-012 | 插件崩溃重启 | P2 | 待实现 |

---

## E2E-001: 插件注册流程

### 描述
验证插件连接到转发服务后能成功注册，并且注册信息能正确上报到平台。

### 前置条件
- 转发服务运行中 (`localhost:8080`)
- 平台服务运行中 (`localhost:8081`)
- Chrome插件已加载

### 测试步骤
1. 启动转发服务
2. 启动平台服务
3. 加载Chrome插件
4. 插件自动连接到转发服务
5. 插件发送 `register` 消息

### 预期结果
- 转发服务收到 `register` 消息
- 转发服务转发注册信息到平台
- 平台存储插件信息
- 插件收到 `register_ack` 响应
- 平台UI显示插件已连接

### 测试数据
```json
{
  "plugin_id": "chrome-extension-test-001",
  "version": "1.0.0-test",
  "user_agent": "Mozilla/5.0 (Test Browser)",
  "tab_id": 999,
  "url": "https://test.example.com"
}
```

---

## E2E-002: 心跳保活机制

### 描述
验证心跳消息能正确发送和响应，连接超时能被检测。

### 前置条件
- 插件已成功注册
- 连接状态为活跃

### 测试步骤
1. 插件发送 `heartbeat` 消息（sequence=1）
2. 验证收到 `heartbeat_ack` 响应
3. 等待30秒
4. 插件发送 `heartbeat` 消息（sequence=2）
5. 停止发送心跳超过60秒
6. 验证连接被断开

### 预期结果
- 每个心跳都能收到正确的ACK响应
- ACK中的sequence与请求匹配
- 超时后连接被断开
- 平台显示插件离线

---

## E2E-003: DOM捕获命令执行

### 描述
验证平台下发DOM捕获命令后，插件能正确执行并返回DOM数据。

### 前置条件
- 插件已连接并注册
- 测试页面已加载（包含复杂DOM结构）

### 测试步骤
1. 平台发送 `capture_dom` 命令
2. 插件接收命令
3. 插件调用WASM模块捕获DOM
4. 插件返回 `dom_data` 消息
5. 平台接收并解析DOM数据

### 预期结果
- 命令正确路由到目标插件
- DOM捕获时间 < 50ms
- 返回的节点数量正确
- 节点属性完整
- 平台能渲染DOM树

### 测试页面结构
```html
<html>
  <body>
    <div id="container">
      <h1>Test Page</h1>
      <p class="text">Paragraph 1</p>
      <p class="text">Paragraph 2</p>
      <ul>
        <li>Item 1</li>
        <li>Item 2</li>
      </ul>
    </div>
  </body>
</html>
```

### 预期节点数
- 至少包含15个节点
- 包含文本节点
- 包含元素节点

---

## E2E-004: XPath查询命令执行

### 描述
验证XPath查询命令能正确执行并返回匹配结果。

### 前置条件
- 插件已连接并注册
- 测试页面已加载

### 测试步骤
1. 平台发送 `query_xpath` 命令
2. 插件执行XPath查询
3. 插件返回 `xpath_result` 消息
4. 验证结果正确性

### 测试用例

| ID | XPath表达式 | 预期匹配数 |
|----|-------------|-----------|
| XP-001 | `//p` | 2 |
| XP-002 | `//p[@class='text']` | 2 |
| XP-003 | `//ul/li` | 2 |
| XP-004 | `//h1[text()='Test Page']` | 1 |
| XP-005 | `//*[@id='container']` | 1 |
| XP-006 | `//div[@id='nonexistent']` | 0 |
| XP-007 | `//p[1]` | 1 |
| XP-008 | `//li[contains(text(),'Item')]` | 2 |

### 预期结果
- 所有测试用例的匹配数正确
- 返回的节点属性正确
- 文本内容正确

---

## E2E-005: 页面跳转命令执行

### 描述
验证页面跳转命令能正确执行，并能等待页面加载完成。

### 前置条件
- 插件已连接并注册

### 测试步骤
1. 平台发送 `navigate` 命令（目标URL）
2. 插件执行页面跳转
3. 等待页面加载完成
4. 插件返回 `navigate_result` 消息
5. 验证当前URL是否正确

### 测试URL
- `https://example.com`
- `https://github.com`
- `https://www.wikipedia.org`

### 预期结果
- 跳转成功
- 返回正确的最终URL
- 返回页面标题
- 加载时间合理（< 30秒）

---

## E2E-006: 日志上报和聚合

### 描述
验证日志能正确上报到平台，并在平台UI中展示。

### 前置条件
- 插件已连接并注册
- 平台日志接收服务运行中

### 测试步骤
1. 插件执行各种操作（DOM捕获、XPath查询等）
2. 插件生成日志
3. 插件发送 `log_report` 消息
4. 平台接收并存储日志
5. 平台UI展示日志列表

### 测试日志级别
- DEBUG
- INFO
- WARN
- ERROR

### 预期结果
- 日志正确上报
- 日志时间戳正确
- 日志级别正确
- 平台UI能实时显示日志

---

## E2E-007: 网络中断恢复

### 描述
验证网络中断后能自动重连并恢复通信。

### 前置条件
- 插件已连接并注册
- 正常通信中

### 测试步骤
1. 模拟网络中断（断开转发服务）
2. 等待插件检测到连接断开
3. 恢复网络（重启转发服务）
4. 验证插件自动重连
5. 验证重连后能正常通信

### 预期结果
- 插件能检测到连接断开
- 插件尝试重连
- 重连成功
- 重连后能正常收发消息
- 平台显示插件重新在线

---

## E2E-008: 转发服务重启恢复

### 描述
验证转发服务重启后，插件能自动重连。

### 前置条件
- 插件已连接并注册

### 测试步骤
1. 正常通信中
2. 重启转发服务
3. 等待插件检测到连接断开
4. 验证插件自动重连
5. 验证重连后能正常通信

### 预期结果
- 插件能检测到连接断开
- 插件尝试重连
- 重连成功
- 无需手动刷新页面

---

## E2E-009: 并发多插件连接

### 描述
验证多个插件能同时连接并正常工作。

### 前置条件
- 转发服务运行中
- 平台服务运行中

### 测试步骤
1. 同时启动10个插件（或10个标签页）
2. 验证所有插件都能成功注册
3. 向所有插件发送DOM捕获命令
4. 验证所有插件都能正确响应
5. 验证平台能正确显示所有插件

### 预期结果
- 所有插件都能成功连接
- 所有插件都能独立收发消息
- 消息不会串台（不会路由到错误的插件）
- 平台能正确显示所有插件状态

---

## E2E-010: 大DOM树传输

### 描述
验证大DOM树（10万节点）能正确捕获和传输。

### 前置条件
- 插件已连接并注册

### 测试步骤
1. 导航到大DOM测试页面
2. 发送DOM捕获命令
3. 验证捕获时间 < 5秒
4. 验证返回的节点数量正确
5. 验证数据完整性

### 预期结果
- 捕获成功
- 节点数量正确
- 消息大小合理（< 50MB）
- 传输时间合理（< 10秒）

---

## E2E-011: 命令超时重试

### 描述
验证命令超时后能正确处理和重试。

### 前置条件
- 插件已连接并注册

### 测试步骤
1. 平台发送DOM捕获命令
2. 模拟插件无响应
3. 等待超时
4. 验证平台发送超时错误
5. 验证重试机制

### 预期结果
- 超时后发送错误消息
- 重试次数正确
- 最终返回超时错误

---

## E2E-012: 插件崩溃重启

### 描述
验证插件崩溃后能被检测到，平台能正确显示状态。

### 前置条件
- 插件已连接并注册

### 测试步骤
1. 正常通信中
2. 模拟插件崩溃（杀死插件进程）
3. 验证转发服务检测到断开
4. 验证平台显示插件离线
5. 重新加载插件
6. 验证插件重新注册

### 预期结果
- 崩溃能被及时检测
- 平台显示离线状态
- 重启后能重新注册

---

## 🧪 测试执行

### 使用 Playwright 执行 E2E 测试

```bash
# 安装依赖
npm install

# 运行所有E2E测试
npm run test:e2e

# 运行特定测试
npm run test:e2e -- --grep "E2E-001"
```

### 使用 Docker Compose 启动测试环境

```bash
# 启动所有服务
docker-compose -f docker-compose.test.yml up

# 运行测试
npm run test:e2e

# 停止服务
docker-compose -f docker-compose.test.yml down
```

---

**老王我警告你：这些测试场景必须全部通过才能上线！**
